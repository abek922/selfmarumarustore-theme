{% comment %} MRST Header (Side Drawer) — hardened & scoped {% endcomment %}

<link
  rel="stylesheet"
  href="{{ 'component-custom-card.css' | asset_url }}"
  media="print"
  fetchpriority="low"
  onload="this.media='all'"
>
<script src="{{ 'header.js' | asset_url }}" defer="defer"></script>
{%- if request.page_type != 'search' -%}
  <script src="{{ 'search.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- liquid
  assign header_layout = section.settings.header_layout
  assign sticky_header = section.settings.sticky_header
  assign menu = section.settings.menu
  assign menu_mobile = section.settings.menu_mobile
  if menu_mobile == blank
    assign menu_mobile = menu
  endif

  assign hamburger_position = section.settings.hamburger_position | default: 'left'
  assign drawer_side = section.settings.drawer_side | default: 'left'
  assign drawer_width = section.settings.drawer_width | default: '320'
  assign drawer_bg = section.settings.drawer_bg | default: '#ffffff'

  assign classes = 'header items-center'
  assign classes = classes | append: ' color-' | append: section.settings.color_scheme
  if section.settings.show_sperator_line
    assign classes = classes | append: ' header--show-sperator-line'
  endif

  assign custom_link = section.blocks | where: 'type', 'custom_link' | first
-%}

{% style %}
  /* ===== Section-scoped variables ===== */
  #shopify-section-{{ section.id }} {
    --logo-width: {{ settings.logo_width }}px;
    --logo-width-mobile: {{ settings.logo_width_mobile }}px;
    --mrst-drawer-width: {{ drawer_width }}px;
    --mrst-drawer-bg: {{ drawer_bg }};
  }
  #shopify-section-{{ section.id }} .header__top {
    --section-padding-top: {{ section.settings.header_top_padding_top }}px;
    --section-padding-bottom: {{ section.settings.header_top_padding_bottom }}px;
  }
  @media (max-width: 1023px) {
    #shopify-section-{{ section.id }} .header__top {
      --section-padding-top: 1.6rem;
      --section-padding-bottom: 1.6rem;
    }
  }

  /* ====== SCOPED Hamburger (他CSSの干渉を無視する強スタイル) ====== */
  #shopify-section-{{ section.id }} .mrst-hamburger{
    width:40px;height:40px;min-width:40px;min-height:40px;
    display:inline-flex;align-items:center;justify-content:center;
    padding:0;margin:0;background:transparent;border:0;
    cursor:pointer;line-height:1;position:relative;appearance:none;
  }
  #shopify-section-{{ section.id }} .mrst-hamburger:before,
  #shopify-section-{{ section.id }} .mrst-hamburger:after{content:none;}
  #shopify-section-{{ section.id }} .mrst-hamburger *{box-shadow:none;}

  #shopify-section-{{ section.id }} .mrst-hamburger__bar{
    display:block;position:absolute;left:50%;
    width:22px;height:2px;background:currentColor;
    transform:translateX(-50%);
    transition:transform .22s ease,width .18s ease,opacity .18s ease,top .18s ease,bottom .18s ease;
  }
  /* 2本線：下が短い（ご指定のイメージ）*/
  #shopify-section-{{ section.id }} .mrst-hamburger__bar--top{ top:13px; }
  #shopify-section-{{ section.id }} .mrst-hamburger__bar--bottom{ bottom:13px; width:14px; }

  /* 開いたら ✗ に変形 */
  #shopify-section-{{ section.id }} .mrst-hamburger.is-open .mrst-hamburger__bar--top{
    transform:translateX(-50%) rotate(45deg);
  }
  #shopify-section-{{ section.id }} .mrst-hamburger.is-open .mrst-hamburger__bar--bottom{
    transform:translateX(-50%) rotate(-45deg);
    width:22px;
  }

  /* 右端配置時もベースライン揃え */
  #shopify-section-{{ section.id }} .header__icons--right .mrst-hamburger{ margin:0; }

  /* ===== Drawer panel 背景色（透過対策） ===== */
  #shopify-section-{{ section.id }} .mrst-drawer__panel{
    background: var(--mrst-drawer-bg) !important;
  }

    /* ====== PC修正: 重なり/余白/二段落ちの総合対策 ====== */
  @media (min-width: 1024px) {
    /* 1) 上段は4カラムグリッド（左アイコン / ロゴ / 検索 / 右アイコン） */
    #shopify-section-{{ section.id }} .header__top{
      display: grid !important;
      grid-template-columns: auto auto minmax(200px, 28vw) auto;
      align-items: center !important;
      column-gap: 8px;
      row-gap: 0;
      position: relative;
      /* 高さのブレを抑止 */
      min-height: 64px;
    }

    /* 2) ロゴ：中央/余白を削減（左右の“空き”を詰める） */
    #shopify-section-{{ section.id }} .header__logo{
      grid-column: 2 !important;
      justify-self: center;
      align-self: center;
      z-index: 3 !important; /* ロゴ > 検索 */
      margin: 0 !important;
    }
    #shopify-section-{{ section.id }} .header__logo > a{
      padding: 0 !important;
      margin: 0 !important;
      line-height: 1 !important;
    }

    /* 3) 検索：右寄せ／幅を抑えて右アイコンに被らない */
    #shopify-section-{{ section.id }} .header__search{
      grid-column: 3 !important;
      justify-self: end;
      align-self: center;
      max-width: min(28vw, 420px);
      width: 100%;
      z-index: 2 !important; /* 右アイコンより下 */
      margin: 0 !important;
    }
    /* 内部入力のはみ出しや高さ差を抑制（テーマ差分吸収） */
    #shopify-section-{{ section.id }} .header__search input,
    #shopify-section-{{ section.id }} .header__search .predictive-search{
      max-width: 100%;
      height: 40px;
      line-height: 40px;
    }

    /* 4) 右アイコン：最前面にして検索の上に重ならないように */
    #shopify-section-{{ section.id }} .header__icons--right{
      grid-column: 4 !important;
      justify-self: end;
      align-self: center !important;
      position: static !important;
      transform: none !important;
      margin: 0 !important;
      display: inline-flex !important;
      z-index: 4 !important; /* 右アイコン > ロゴ > 検索 */
    }
    #shopify-section-{{ section.id }} .header__icons--right .header__buttons{
      align-items: center !important;
      gap: 8px;
    }

    /* 5) ハンバーガー左配置：左端に固定 */
    #shopify-section-{{ section.id }} .header__top[data-hpos="left"] .header__icons--left{
      grid-column: 1 !important;
      justify-self: start;
      align-self: center !important;
      position: static !important;
      transform: none !important;
      margin: 0 !important;
      display: inline-flex !important;
      z-index: 4 !important; /* 左アイコンも最前面 */
    }

    /* 6) 既存のfloat/absolute等の影響を打ち消し */
    #shopify-section-{{ section.id }} .header__top .header__icons--left,
    #shopify-section-{{ section.id }} .header__top .header__icons--right,
    #shopify-section-{{ section.id }} .header__top .header__search,
    #shopify-section-{{ section.id }} .header__top .header__logo{
      float: none !important;
    }

    /* 7) 二段落ちの原因を根本排除：このカスタムヘッダー内では下段ナビを非表示 */
    #shopify-section-{{ section.id }} .header__bottom{
      display: none !important;
    }

    /* 8) 行落ち保険：ボタン高さを統一 */
    #shopify-section-{{ section.id }} .header__buttons > *{
      min-height: 40px;
    }

    /* 9) 余白の微調整（念のため） */
    #shopify-section-{{ section.id }} .header__top .header__logo,
    #shopify-section-{{ section.id }} .header__top .header__search{
      margin-top: 0 !important;
      margin-bottom: 0 !important;
    }
  }

{% endstyle %}

<header
  data-section-id="{{ section.id }}"
  class="{{ classes }}"
  {% if sticky_header != 'none' %}
    is="sticky-header" data-sticky-type="{{ sticky_header }}"
    data-collapse-on-scroll="{{ section.settings.enable_collapse_on_scroll }}"
  {% else %}
    is="basic-header"
  {% endif %}
>
  <div
  class="header__top header__top--{{ header_layout }} items-center relative section--padding page-width page-width--{{ section.settings.container }}"
  data-hpos="{{ hamburger_position }}"
>

    {%- if hamburger_position == 'left' -%}
      <div class="header__icons header__icons--left lg:justify-start z-1">
        <div class="header__buttons flex items-center">
          <button
            class="mrst-hamburger btn btn--inherit inline-flex items-center justify-center"
            id="mrst-hamburger"
            type="button"
            aria-controls="mrst-drawer"
            aria-label="{{ 'accessibility.menu_drawer' | t }}"
            aria-expanded="false"
            data-mrst-toggle
          >
            <span class="mrst-hamburger__bar mrst-hamburger__bar--top"></span>
            <span class="mrst-hamburger__bar mrst-hamburger__bar--bottom"></span>
          </button>
        </div>
      </div>
    {%- endif -%}

    {%- if request.page_type == 'index' -%}
      <h1 class="header__logo flex justify-center items-center z-1">
    {%- else -%}
      <div class="header__logo flex justify-center items-center z-1">
    {%- endif -%}
      <a href="{{ routes.root_url }}" class="h3 relative flex{% unless settings.logo %} header__logo--text{% else %} header__logo--image{% endunless %}">
        {%- if settings.logo != blank -%}
          {%- liquid
            assign logo = settings.logo
            assign logo_width = settings.logo_width
            assign logo_width_2x = settings.logo_width | times: 2
            assign logo_mobile = settings.logo_mobile | default: logo
            assign logo_width_mobile = settings.logo_width_mobile
            assign logo_width_mobile_2x = settings.logo_width_mobile | times: 2
          -%}
          {%- if logo_mobile -%}
            <img srcset="{{ logo_mobile | image_url: width: logo_width_mobile }} 1x, {{ logo_mobile | image_url: width: logo_width_mobile_2x }} 2x"
                 src="{{ logo_mobile | image_url: width: logo_width_mobile }}"
                 loading="eager" width="{{ logo_mobile.width }}" height="{{ logo_mobile.height }}"
                 alt="{{ logo_mobile.alt | default: shop.name | escape }}"
                 class="logo header__logo--mobile lg:hidden">
          {%- endif -%}
          <img srcset="{{ logo | image_url: width: logo_width }} 1x, {{ logo | image_url: width: logo_width_2x }} 2x"
               src="{{ logo | image_url: width: logo_width }}"
               loading="eager" width="{{ logo.width }}" height="{{ logo.height }}"
               alt="{{ logo.alt | default: shop.name | escape }}"
               class="logo header__logo--desktop lg:block hidden">
        {%- else -%}
          {{ shop.name }}
        {%- endif -%}
      </a>
    {%- if request.page_type == 'index' -%}</h1>{%- else -%}</div>{%- endif -%}

    <div class="header__search flex items-center z-2">
      {%- render 'predictive-search' -%}
      <button class="btn btn--inherit header__search-close inline-flex btn-remove" aria-label="{{ 'general.search.close_search' | t }}">
        {%- render 'icon-close', class: 'pointer-events-none' -%}
      </button>
    </div>

    <div class="header__icons header__icons--right flex justify-end z-1">
      <div class="header__buttons flex items-center justify-center">

        {%- if hamburger_position == 'right' -%}
          <button
            class="mrst-hamburger btn btn--inherit inline-flex items-center justify-center"
            id="mrst-hamburger"
            type="button"
            aria-controls="mrst-drawer"
            aria-label="{{ 'accessibility.menu_drawer' | t }}"
            aria-expanded="false"
            data-mrst-toggle
          >
            <span class="mrst-hamburger__bar mrst-hamburger__bar--top"></span>
            <span class="mrst-hamburger__bar mrst-hamburger__bar--bottom"></span>
          </button>
        {%- endif -%}

        {%- if custom_link and custom_link.settings.label != blank -%}
          <a href="{{ custom_link.settings.link | default: '#' }}" class="cusstom-button flex items-center justify-center gap-2 reversed-link" aria-label="{{ custom_link.settings.label }}">
            {%- if custom_link.settings.custom_icon != blank -%}
              <span class="icon icon--{{ custom_link.settings.icon_size }}">
                {{- custom_link.settings.custom_icon | image_url: width: 30 | image_tag: loading: 'lazy', class: 'motion-reduce', is: 'image-lazy' -}}
              </span>
            {%- else -%}
              {%- render 'icons', icon: custom_link.settings.icon, size: custom_link.settings.icon_size -%}
            {%- endif -%}
            <span class="reversed-link__text hidden sm:block lg:hidden xl:block whitespace-nowrap">
              {{ custom_link.settings.label }}
            </span>
          </a>
        {%- endif -%}

        {%- if shop.customer_accounts_enabled -%}
          <a href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}" class="account-button reversed-link flex items-center justify-center gap-2" aria-label="{{ 'customer.account.title' | t }}">
            {%- render 'icon-account', size: 'large' -%}
            <span class="reversed-link__text hidden sm:block lg:hidden xl:block whitespace-nowrap">
              {%- liquid
                if customer
                  echo 'customer.account_fallback' | t
                else
                  echo 'customer.account_action' | t
                endif
              -%}
            </span>
          </a>
        {%- endif -%}

        {%- liquid
          assign cart_icon_inline_css = ''
          if settings.cart_icon_color != blank and settings.cart_icon_color != 'rgba(0,0,0,0)'
            assign cart_icon_inline_css = cart_icon_inline_css | append: '--cart-icon-color:' | append: settings.cart_icon_color | append: ';'
          endif
          if settings.cart_icon_background != blank and settings.cart_icon_background != 'rgba(0,0,0,0)'
            assign cart_icon_inline_css = cart_icon_inline_css | append: '--cart-icon-background:' | append: settings.cart_icon_background | append: ';'
          endif
        -%}
        <a
          href="{{ routes.cart_url }}"
          class="cart-drawer-button flex items-center justify-center relative cart-icon cart-icon--{{ settings.cart_style }}"
          {% if request.page_type != 'cart' and settings.cart_type == 'drawer' %} aria-controls="CartDrawer" {% endif %}
          {% if cart_icon_inline_css != blank %} style="{{ cart_icon_inline_css }}" {% endif %}
        >
          {%- render 'icon-cart', size: 'large', name: settings.cart_icon -%}
          <span class="visually-hidden">{{ 'templates.cart.cart' | t }}</span>
          <cart-count
            class="cart-count cart-count--absolute{% if cart.item_count > 99 %} cart-count--small-medium{% endif %}"
            aria-label="{{ 'general.cart.cart_count' | t: count: cart.item_count | escape }}"
            {% if cart == empty %} hidden {% endif %}
          >
            {%- if cart.item_count < 100 -%}{{- cart.item_count -}}{%- else -%}<span class="text-sm-extra">99+</span>{%- endif -%}
          </cart-count>
        </a>
      </div>
    </div>
  </div>

  {%- comment -%} ドロップダウンは使わない {%- endcomment -%}

  <div class="mrst-drawer" id="mrst-drawer" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Site menu" data-side="{{ drawer_side }}">
    <div class="mrst-drawer__overlay" data-mrst-close></div>
    <aside class="mrst-drawer__panel" tabindex="-1">
      <div class="mrst-drawer__header">
        <span class="mrst-drawer__title">{{ shop.name }}</span>
        <button class="mrst-drawer__close" type="button" aria-label="Close menu" data-mrst-close>&times;</button>
      </div>

      <nav class="mrst-drawer__nav" aria-label="{{ 'general.navigation' | t }}">
        {%- for i in (1..4) -%}
          {%- assign menu_id = 'menu_' | append: i -%}
          {%- assign title_id = 'menu_' | append: i | append: '_title' -%}
          {%- assign divider_id = 'menu_' | append: i | append: '_divider' -%}
          {%- assign menu_handle = section.settings[menu_id] -%}
          {%- assign group_title = section.settings[title_id] -%}
          {%- assign show_divider = section.settings[divider_id] -%}

          {%- if menu_handle != blank -%}
            <div class="mrst-group">
              {%- if group_title != blank -%}
                <h3 class="mrst-group__title">{{ group_title }}</h3>
              {%- endif -%}

              <ul class="mrst-drawer__list">
                {%- for link in linklists[menu_handle].links -%}
                  <li class="mrst-drawer__item">
                    <a class="mrst-drawer__link" href="{{ link.url }}">{{ link.title }}</a>
                    {%- if link.links and link.links.size > 0 -%}
                      <ul class="mrst-drawer__sublist">
                        {%- for sublink in link.links -%}
                          <li class="mrst-drawer__subitem">
                            <a class="mrst-drawer__sublink" href="{{ sublink.url }}">{{ sublink.title }}</a>
                          </li>
                        {%- endfor -%}
                      </ul>
                    {%- endif -%}
                  </li>
                {%- endfor -%}
              </ul>

              {%- if show_divider -%}
                <hr class="mrst-group__divider">
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endfor -%}

        {%- if section.settings.menu_1 == blank and section.settings.menu_2 == blank and section.settings.menu_3 == blank and section.settings.menu_4 == blank -%}
          {%- assign fallback_menu = menu_mobile | default: menu -%}
          {%- if fallback_menu != blank -%}
            <ul class="mrst-drawer__list">
              {% for link in linklists[fallback_menu].links %}
                <li class="mrst-drawer__item">
                  <a class="mrst-drawer__link" href="{{ link.url }}">{{ link.title }}</a>
                  {% if link.links and link.links.size > 0 %}
                    <ul class="mrst-drawer__sublist">
                      {% for sublink in link.links %}
                        <li class="mrst-drawer__subitem">
                          <a class="mrst-drawer__sublink" href="{{ sublink.url }}">{{ sublink.title }}</a>
                        </li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {%- else -%}
            <p class="mrst-drawer__empty">メニューが未設定です。セクション設定からメニューを選択してください。</p>
          {%- endif -%}
        {%- endif -%}
      </nav>
    </aside>
  </div>
</header>

<div class="fixed-overlay fixed-overlay--header-section z-10"></div>

{%- comment -%} 構造化データは既存そのまま {%- endcomment -%}
<script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":{{ shop.name | json }},{% if settings.logo %}"logo":{{ settings.logo | image_url: width: 500 | prepend: "https:" | json }},{% endif %}"sameAs":[{{ settings.social_twitter_link | json }},{{ settings.social_facebook_link | json }},{{ settings.social_pinterest_link | json }},{{ settings.social_instagram_link | json }},{{ settings.social_tiktok_link | json }},{{ settings.social_tumblr_link | json }},{{ settings.social_snapchat_link | json }},{{ settings.social_youtube_link | json }},{{ settings.social_vimeo_link | json }}],"url":{{ request.origin | append: page.url | json }}}</script>

{%- if request.page_type == 'index' -%}
  {% assign potential_action_target = request.origin | append: routes.search_url | append: '?q={search_term_string}' %}
  <script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":{{ shop.name | json }},"potentialAction":{"@type":"SearchAction","target":{{ potential_action_target | json }},"query-input":"required name=search_term_string"},"url":{{ request.origin | append: page.url | json }}}</script>
{%- endif -%}


{% schema %}
{
  "name": "MRST Header (Side Drawer)",
  "class": "header-section",
  "settings": [
    { "type": "header", "content": "t:general.general.name" },
    { "type": "paragraph", "content": "t:sections.header.paragraph.content" },

    { "type": "select", "id": "container", "label": "t:general.container.label",
      "options": [
        { "value": "full", "label": "t:general.container.options__full.label" },
        { "value": "fixed", "label": "t:general.container.options__fixed.label" }
      ],
      "default": "fixed"
    },

    { "type": "color_scheme", "id": "color_scheme", "label": "t:general.colors.label" },

    { "type": "link_list", "id": "menu", "label": "t:general.menu.label", "default": "main-menu" },
    { "type": "link_list", "id": "menu_mobile", "label": "t:general.menu.mobile.label", "default": "main-menu" },

    { "type": "select", "id": "header_layout", "label": "t:sections.header.settings.header_layout.label",
      "options": [
        { "value": "logo-left", "label": "t:sections.header.settings.header_layout.options__1.label" },
        { "value": "logo-center", "label": "t:sections.header.settings.header_layout.options__2.label" }
      ]
    },

    { "type": "select", "id": "sticky_header", "label": "t:sections.header.settings.header_sticky.label",
      "options": [
        { "value": "none", "label": "t:sections.header.settings.header_sticky.options__1.label" },
        { "value": "always", "label": "t:sections.header.settings.header_sticky.options__2.label" },
        { "value": "on-scroll-up", "label": "t:sections.header.settings.header_sticky.options__3.label" }
      ],
      "default": "always"
    },

    { "type": "checkbox", "id": "enable_collapse_on_scroll", "label": "t:sections.header.settings.enable_collapse_on_scroll.label" },
    { "type": "checkbox", "id": "show_sperator_line", "label": "t:general.show_separator_line.label", "default": true },

    { "type": "header", "content": "t:general.mobile.name" },
    { "type": "checkbox", "id": "show_social_media_icons", "label": "t:sections.header.settings.show_social_media_icons.label", "default": true },
    { "type": "checkbox", "id": "enable_language_selector", "label": "t:general.show_language_selector.label", "info": "t:general.show_language_selector.info", "default": true },
    { "type": "checkbox", "id": "enable_country_selector", "label": "t:general.show_country_selector.label", "info": "t:general.show_country_selector.info", "default": true },

    { "type": "header", "content": "t:sections.header.settings.header__top_padding.content" },
    { "type": "range", "id": "header_top_padding_top", "label": "t:general.padding.top.label", "min": 0, "max": 40, "step": 1, "unit": "px", "default": 24 },
    { "type": "range", "id": "header_top_padding_bottom", "label": "t:general.padding.bottom.label", "min": 0, "max": 40, "step": 1, "unit": "px", "default": 8 },

    { "type": "header", "content": "SELF 〇〇 STORE" },
    { "type": "select", "id": "hamburger_position", "label": "ハンバーガー位置",
      "options": [ { "value": "left", "label": "左端" }, { "value": "right", "label": "右端" } ],
      "default": "left"
    },
    { "type": "select", "id": "drawer_side", "label": "メニューのスライド方向",
      "options": [ { "value": "left", "label": "左から" }, { "value": "right", "label": "右から" } ],
      "default": "left"
    },
    { "type": "select", "id": "drawer_width", "label": "メニュー幅（px）",
      "options": [
        { "value": "280", "label": "280" }, { "value": "320", "label": "320" },
        { "value": "360", "label": "360" }, { "value": "400", "label": "400" }
      ],
      "default": "320"
    },
    { "type": "color", "id": "drawer_bg", "label": "メニュー背景色", "default": "#ffffff" },

    { "type": "header", "content": "メニューグループ 1" },
    { "type": "link_list", "id": "menu_1", "label": "メニュー 1" },
    { "type": "text", "id": "menu_1_title", "label": "タイトル（任意）" },
    { "type": "checkbox", "id": "menu_1_divider", "label": "区切り線を表示", "default": false },

    { "type": "header", "content": "メニューグループ 2" },
    { "type": "link_list", "id": "menu_2", "label": "メニュー 2" },
    { "type": "text", "id": "menu_2_title", "label": "タイトル（任意）" },
    { "type": "checkbox", "id": "menu_2_divider", "label": "区切り線を表示", "default": false },

    { "type": "header", "content": "メニューグループ 3" },
    { "type": "link_list", "id": "menu_3", "label": "メニュー 3" },
    { "type": "text", "id": "menu_3_title", "label": "タイトル（任意）" },
    { "type": "checkbox", "id": "menu_3_divider", "label": "区切り線を表示", "default": false },

    { "type": "header", "content": "メニューグループ 4" },
    { "type": "link_list", "id": "menu_4", "label": "メニュー 4" },
    { "type": "text", "id": "menu_4_title", "label": "タイトル（任意）" },
    { "type": "checkbox", "id": "menu_4_divider", "label": "区切り線を表示", "default": false }
  ],
  "blocks": [],
  "enabled_on": { "groups": ["header"] },
  "presets": [
    { "name": "MRST Header (Side Drawer)", "category": "SELF 〇〇 STORE" }
  ]
}
{% endschema %}
