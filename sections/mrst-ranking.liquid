{{ 'section-featured-collection.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign columns_desktop = section.settings.columns | default: 4
  assign columns_mobile  = section.settings.columns_mobile | default: '1'
  assign limit           = section.settings.limit | default: 8

  assign header_alignment = section.settings.section_header_alignment
  assign header_alignment_mobile = section.settings.section_header_alignment_mobile
  if header_alignment_mobile == 'inherit'
    assign header_alignment_mobile = header_alignment
  endif

  assign has_richtext = false
  if section.settings.heading != blank or section.settings.description != blank or section.settings.subheading != blank
    assign has_richtext = true
  endif
-%}

{%- capture image_sizes -%}
(max-width: 767px) calc((100vw - 30px) / {{ columns_mobile }}),
calc(100vw / {{ columns_desktop }})
{%- endcapture -%}

{% style %}
  .section-{{ section.id }}{
    --section-padding-top: {{ section.settings.padding_top }}px;
    --section-padding-bottom: {{ section.settings.padding_bottom }}px;
    --f-columns-xl: {{ columns_desktop }};
    --f-columns-mobile: {{ columns_mobile }};
  }
  .section-{{ section.id }} .mrst-tabs-nav{ margin:12px 0 20px; overflow:auto; }
  .section-{{ section.id }} .mrst-tabs-nav__inner{ display:flex; gap:12px; }
  .section-{{ section.id }} .mrst-tab{
    appearance:none; background:none; border:none; padding:6px 10px; cursor:pointer;
    border-bottom:2px solid transparent; white-space:nowrap;
  }
  .section-{{ section.id }} .mrst-tab.is-active{ border-color: currentColor; }
  .section-{{ section.id }} .mrst-tab-panel{ display:none; }
  .section-{{ section.id }} .mrst-tab-panel.is-active{ display:block; }

  /* グリッド（テーマの f-grid ユーティリティに合わせた最小指定） */
  .section-{{ section.id }} .mrst-ranking-grid{
    display:grid;
    grid-template-columns: repeat(var(--f-columns-xl), minmax(0,1fr));
  }
  @media (max-width: 767px){
    .section-{{ section.id }} .mrst-ranking-grid{
      grid-template-columns: repeat(var(--f-columns-mobile), minmax(0,1fr));
    }
  }
  /* === MRST: ランキング番号バッジ === */
  .section-{{ section.id }} .mrst-rank-wrap{ position: relative; }
  .section-{{ section.id }} .mrst-rank-badge{
    position: absolute;
    top: 8px; left: 8px;
    z-index: 5;
    min-width: 28px; height: 28px;
    padding: 0 8px;
    border-radius: 9999px;
    display: inline-flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; line-height: 1;
    color: #fff;
    background: rgba(0,0,0,.7);
    box-shadow: 0 2px 6px rgba(0,0,0,.18);
    pointer-events: none;   /* クリック干渉しない */
  }
  /* 1〜3位を少し強調（任意） */
  .section-{{ section.id }} .mrst-rank-badge[data-rank="1"]{ background:#111; }
  .section-{{ section.id }} .mrst-rank-badge[data-rank="2"]{ background:#333; }
  .section-{{ section.id }} .mrst-rank-badge[data-rank="3"]{ background:#555; }
{% endstyle %}

{% render 'divider',
  show_divider: section.settings.show_section_divider,
  divider_width: section.settings.divider_width
%}

<div class="section section-{{ section.id }} section--padding color-{{ section.settings.color_scheme }}" data-id="{{ section.id }}">
  <div class="section__container page-width page-width--{{ section.settings.container }}">
    <div class="section__wrapper" data-section-id="{{ section.id }}">

      {%- if has_richtext -%}
      <div class="section__header s__header rich-text rich-text--tight md:text-{{ header_alignment }} text-{{ header_alignment_mobile }}">
        {% if section.settings.subheading != blank %}
          <div class="rich-text__subheading text-subheading">{{ section.settings.subheading }}</div>
        {% endif %}
        {% if section.settings.heading != blank %}
          <h2 class="rich-text__heading inline-richtext {{ section.settings.heading_size }}">
            {% render 'highlight-text',
              hl_text: section.settings.heading,
              hl_style: section.settings.highlight_style,
              hl_font_style: section.settings.highlight_font_style,
              hl_style_color: section.settings.highlight_style_color,
              hl_text_color: section.settings.highlight_text_color
            %}
          </h2>
        {% endif %}
        {% if section.settings.description != blank %}
          <div class="rich-text__text rte {{ section.settings.text_size }} text-subtext">
            {{ section.settings.description }}
          </div>
        {% endif %}
      </div>
      {%- endif -%}

      {%- if section.blocks.size > 1 -%}
        <div class="mrst-tabs-nav" role="tablist" aria-label="Ranking tabs">
          <div class="mrst-tabs-nav__inner">
            {% for block in section.blocks %}
              {% assign coll = collections[block.settings.collection] %}
              {% if coll %}
                <button
                  class="mrst-tab{% if forloop.first %} is-active{% endif %}"
                  role="tab"
                  data-index="{{ forloop.index0 }}"
                  {{ block.shopify_attributes }}
                >
                  {{ block.settings.title | default: coll.title }}
                </button>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {%- endif -%}

      <div class="section__content tabs__panels">
        {% for block in section.blocks %}
          {% assign coll = collections[block.settings.collection] %}
          {% if coll %}
            <div
              class="mrst-tab-panel{% if forloop.first %} is-active{% endif %}"
              role="tabpanel"
              data-index="{{ forloop.index0 }}"
              {{ block.shopify_attributes }}
            >
              {%- comment -%}
                ランキング（売上順）について：
                Liquid ではベストセラーのソートキー指定ができないため、
                対象コレクションの「並び順」を管理画面で「ベストセラー」に設定してください。
              {%- endcomment -%}
              <div class="mrst-ranking-grid f-grid f-grid--gap-{{ section.settings.column_gap }} f-grid--row-gap-{{ section.settings.row_gap }}">
                {% for product in coll.products limit: limit %}
                <div class="f-column">
                    <div class="mrst-rank-wrap">
                    <span class="mrst-rank-badge" data-rank="{{ forloop.index }}">{{ forloop.index }}</span>
                    {% render 'card-product',
                        product: product,
                        parent_color_scheme: section.settings.color_scheme,
                        image_sizes: image_sizes,
                        image_ratio: section.settings.pcard_image_ratio,
                        section_index: section.index,
                        index: forloop.index
                    %}
                    </div>
                </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const root = document.querySelector('.section-{{ section.id }}');
  if(!root) return;
  const tabs = root.querySelectorAll('.mrst-tab');
  const panels = root.querySelectorAll('.mrst-tab-panel');
  tabs.forEach((tab, i) => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('is-active'));
      panels.forEach(p => p.classList.remove('is-active'));
      tab.classList.add('is-active');
      if (panels[i]) panels[i].classList.add('is-active');
    });
  });
});
</script>

{% schema %}
{
  "name": "MRST Ranking",
  "disabled_on": { "groups": ["header", "footer", "custom.overlay"] },
  "settings": [
    { "type": "header", "content": "General" },
    {
      "type": "select",
      "id": "container",
      "label": "Container",
      "options": [
        { "value": "full", "label": "Full width" },
        { "value": "fixed", "label": "Fixed width" }
      ],
      "default": "fixed"
    },
    { "type": "color_scheme", "id": "color_scheme", "label": "Colors", "default": "scheme-1" },

    { "type": "header", "content": "Heading" },
    { "type": "inline_richtext", "id": "subheading", "label": "Subheading" },
    { "type": "inline_richtext", "id": "heading", "label": "Heading", "default": "RANKING" },
    {
      "type": "select",
      "id": "highlight_style",
      "label": "Highlight style",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "hand_drawn_circle", "label": "Hand drawn circle" },
        { "value": "thick_underline", "label": "Thick underline" },
        { "value": "wave_underline", "label": "Wave underline" }
      ],
      "default": "none"
    },
    {
      "type": "select",
      "id": "highlight_font_style",
      "label": "Highlight font style",
      "options": [
        { "value": "italic", "label": "Italic" },
        { "value": "normal", "label": "Normal" }
      ],
      "default": "normal"
    },
    { "type": "color", "id": "highlight_style_color", "label": "Highlight color" },
    { "type": "color", "id": "highlight_text_color", "label": "Highlight text color" },
    {
      "id": "section_header_alignment",
      "type": "select",
      "label": "Heading alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "id": "section_header_alignment_mobile",
      "type": "select",
      "label": "Heading alignment (mobile)",
      "default": "inherit",
      "options": [
        { "value": "inherit", "label": "Inherit" },
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    { "type": "richtext", "id": "description", "label": "Description" },

    { "type": "header", "content": "Grid" },
    { "type": "range", "id": "limit", "label": "Products to show", "min": 2, "max": 12, "step": 1, "default": 8 },
    { "type": "range", "id": "columns", "label": "Columns (desktop)", "min": 2, "max": 6, "step": 1, "default": 4 },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "1"
    },
    {
      "type": "select",
      "id": "pcard_image_ratio",
      "label": "Product image ratio",
      "default": "",
      "options": [
        { "value": "", "label": "Inherit" },
        { "value": "adapt", "label": "Adapt" },
        { "value": "1/1", "label": "1:1" },
        { "value": "3/4", "label": "3:4" },
        { "value": "4/3", "label": "4:3" }
      ]
    },
    {
      "type": "select",
      "id": "column_gap",
      "label": "Column gap",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "2xs", "label": "2xs" },
        { "value": "extra-small", "label": "XS" },
        { "value": "small", "label": "SM" },
        { "value": "medium", "label": "MD" },
        { "value": "large", "label": "LG" },
        { "value": "extra-large", "label": "XL" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "row_gap",
      "label": "Row gap",
      "options": [
        { "value": "inherit", "label": "Inherit" },
        { "value": "none", "label": "None" },
        { "value": "extra-small", "label": "XS" },
        { "value": "small", "label": "SM" },
        { "value": "medium", "label": "MD" },
        { "value": "large", "label": "LG" },
        { "value": "extra-large", "label": "XL" }
      ],
      "default": "inherit"
    },

    { "type": "header", "content": "Padding & Divider" },
    { "type": "range", "id": "padding_top", "label": "Padding top", "min": 0, "max": 100, "step": 2, "unit": "px", "default": 50 },
    { "type": "range", "id": "padding_bottom", "label": "Padding bottom", "min": 0, "max": 100, "step": 2, "unit": "px", "default": 50 },
    { "type": "checkbox", "id": "show_section_divider", "label": "Show divider", "default": false },
    {
      "type": "select",
      "id": "divider_width",
      "label": "Divider width",
      "options": [
        { "value": "fixed", "label": "Fixed" },
        { "value": "full", "label": "Full" }
      ],
      "default": "fixed"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "limit": 8,
      "settings": [
        { "type": "collection", "id": "collection", "label": "Collection" },
        { "type": "text", "id": "title", "label": "Tab label (optional)" }
      ]
    }
  ],
  "presets": [
    {
      "name": "MRST Ranking",
      "category": "SELF 〇〇 STORE",
      "blocks": [
        { "type": "collection" },
        { "type": "collection" },
        { "type": "collection" }
      ]
    }
  ]
}
{% endschema %}
