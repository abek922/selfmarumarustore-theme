{% comment %}
  付与ポイント表示ブロック
  main-cartセクション内のブロックとして使用
{% endcomment %}

{% assign point_rate = block.settings.point_rate | default: 1 %}
{% assign total_point_eligible_amount = 0 %}

{% comment %} カート内の商品をループして、ポイント対象商品の税抜合計金額を計算 {% endcomment %}
{% for item in cart.items %}
  {% assign is_point_eligible = true %}
  
  {% comment %} 商品にポイント対象外タグがあるかチェック {% endcomment %}
  {% for tag in item.product.tags %}
    {% if tag == 'ポイント対象外' %}
      {% assign is_point_eligible = false %}
      {% break %}
    {% endif %}
  {% endfor %}
  
  {% comment %} ポイント対象商品の場合、税抜金額を合計に加算 {% endcomment %}
  {% if is_point_eligible %}
    {% assign item_price_without_tax = item.final_line_price %}
    {% if cart.taxes_included %}
      {% comment %} 税込み価格から税抜き価格を計算 {% endcomment %}
      {% assign tax_rate = 1 %}
      {% for tax_line in cart.tax_lines %}
        {% assign tax_rate = tax_rate | plus: tax_line.rate %}
      {% endfor %}
      {% assign item_price_without_tax = item.final_line_price | divided_by: tax_rate %}
    {% endif %}
    {% assign total_point_eligible_amount = total_point_eligible_amount | plus: item_price_without_tax %}
  {% endif %}
{% endfor %}

{% comment %} 付与ポイントを計算 {% endcomment %}
{% assign awarded_points = total_point_eligible_amount | times: point_rate | divided_by: 100 | floor %}

{% comment %} ブロックの表示 {% endcomment %}
<div class="cart-point-display" {{ block.shopify_attributes }}>
  <div class="cart-point-display__content">
    <span class="cart-point-display__label">付与予定ポイント：</span>
    <span class="cart-point-display__amount">{{ awarded_points }}ポイント</span>
  </div>
</div>

{% comment %} スタイル {% endcomment %}
<style>
  .cart-point-display {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 12px 16px;
    margin: 16px 0;
  }
  
  .cart-point-display__content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .cart-point-display__label {
    font-weight: 500;
    color: #495057;
  }
  
  .cart-point-display__amount {
    font-weight: 600;
    color: #007bff;
    font-size: 1.1em;
  }
</style>

{% schema %}
{
  "name": "付与ポイント表示",
  "settings": [
    {
      "type": "number",
      "id": "point_rate",
      "label": "ポイント付与率 (%)",
      "default": 1,
      "info": "商品の税抜合計金額に対するポイント付与率を%で入力してください"
    }
  ]
}
{% endschema %}